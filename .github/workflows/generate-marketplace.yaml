name: Marketplace generator

on:
  # Trigger the workflow on push or pull request, only for the main branch
  push:
    branches:
      - marketplace

jobs:
  # Set the job key. The key is displayed as the job name
  # when a job name is not provided
  generate-marketplace:
    # Name the Job
    name: Generate marketplace
    # Set the type of machine to run on
    runs-on: ubuntu-latest

    steps:
      # Source
      - name: Checkout current repo
        uses: actions/checkout@v2
        with:
          path: items
      # Target
      - name: Checkout Marketplace
        uses: actions/checkout@v2
        with:
          persist-credentials: false
          repository: Michaelliv/funcitons-marketplace
          path: marketplace
      # Docs building tool
      - name: Checkout Collagen
        uses: actions/checkout@v2
        with:
          repository: Michaelliv/collagen
          path: collagen
      # Log git directories
      - name: Show information about directories
        run: |
          echo " **************************** Listing items **************************** "
          ls -l items
          echo " **************************** Listing marketplace **************************** "
          ls -l marketplace
          echo " **************************** Listing collagen **************************** "
          ls -l collagen
      # Install python
      - name: Install python
        uses: actions/setup-python@v2
        with:
          python-version: 3.8
      - name: Cache pip
        id: cache
        uses: actions/cache@v2
        with:
          path: /opt/hostedtoolcache/Python/3.8.7/x64/lib/python3.8/site-packages/*
          key: ${{ runner.os }}-pip-${{ hashFiles('collagen/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      # Install tool dependencies
      - name: Install Collagen's requirements.txt
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          python -m pip install --upgrade pip
          pip install -r collagen/requirements.txt
      # Execute collagen
      - name: Execute collagen
        run: |
          python collagen/main.py -s ./items/ -t ./marketplace/
      # Create branch
      - name: Create branch with new marketplace version
        env:
          GITHUB_TOKEN: ${{ secrets.MARKETPLACE_ACCESS_TOKEN }}
          USERNAME: Michaelliv
          REPO_PATH: funcitons-marketplace
        run: |
          cd marketplace

          COMMIT_SHA=$(git rev-parse --short "$GITHUB_SHA")
          BRANCH_NAME=marketplace-doc-gen-$COMMIT_SHA
          REMOTE=https://$USERNAME:$GITHUB_TOKEN@github.com/$USERNAME/$REPO_PATH.git

          echo "Validating environment params...";

          [ -z "${GITHUB_TOKEN}" ] && {
              echo 'Missing input "GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}".';
              exit 1;
          };

          git config --local user.name "github-worflow[bot]"

          echo "Checking out [$BRANCH_NAME]..."
          git checkout -b $BRANCH_NAME

          echo "Commiting changes..."
          git add -A && git commit -m "Automated generating from $COMMIT_SHA"

          echo "Pushing [$BRANCH_NAME] to remote [$REMOTE]"
          git push $REMOTE $BRANCH_NAME

          echo "Submiting pull request..."
          gh pr create --title "Marketplace update from $BRANCH_NAME" --body "github-workflow" --base master --head $BRANCH_NAME --repo $USERNAME/$REPO_PATH